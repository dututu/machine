<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css">-->

    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <!--<meta name="apple-mobile-web-app-capable" content="yes">-->
    <!--<meta name="apple-mobile-web-app-status-bar-style" content="black">-->
    <title>编辑机柜信息</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.2/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.1.2/css/jquery-weui.min.css">
    <link rel="stylesheet" href="__STATIC__/wechatservice/css/mui.min.css">
    <style>
        body {
            height: 100% !important;
            background: #e7e7e7 !important;
        }
        input{
            -webkit-user-select: auto !important;
        }
        .con{
            -webkit-user-select: auto !important;
        }
        .rightnav {
            padding-right: 13px;
            position: relative;
            text-align: right;
            display: inline-block;
        }

        .rightnav:after {
            content: " ";
            display: inline-block;
            height: 6px;
            width: 6px;
            border-width: 2px 2px 0 0;
            border-color: #C8C8CD;
            border-style: solid;
            -webkit-transform: matrix(0.71, 0.71, -0.71, 0.71, 0, 0);
            transform: matrix(0.71, 0.71, -0.71, 0.71, 0, 0);
            position: relative;
            top: -2px;
            position: absolute;
            top: 50%;
            margin-top: -4px;
            right: 2px;
        }

        .upload_head {
            color: #999999;
            font-size: 13px;
        }

        body {
            /*height: 100% !important;*/
            background: #e7e7e7 !important;
        }
        html,
        body {
            background-color: #efeff4;
        }
        .mui-views,
        .mui-view,
        .mui-pages,
        .mui-page,
        .mui-page-content {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background-color: #efeff4;
        }
        .mui-pages {
            height: auto;
        }
        .mui-scroll-wrapper,
        .mui-scroll {
            background-color: #efeff4;
        }
        .mui-page.mui-transitioning {
            -webkit-transition: -webkit-transform 300ms ease;
            transition: transform 300ms ease;
        }
        .mui-page-left {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
        .mui-ios .mui-page-left {
            -webkit-transform: translate3d(-20%, 0, 0);
            transform: translate3d(-20%, 0, 0);
        }
        .mui-navbar .mui-bar {
            position: absolute;
            background: transparent;
            text-align: center;
        }
        .mui-android .mui-navbar-inner.mui-navbar-left {
            opacity: 0;
        }
        .mui-ios .mui-navbar-left .mui-left,
        .mui-ios .mui-navbar-left .mui-center,
        .mui-ios .mui-navbar-left .mui-right {
            opacity: 0;
        }
        .mui-navbar .mui-btn-nav {
            -webkit-transition: none;
            transition: none;
            -webkit-transition-duration: .0s;
            transition-duration: .0s;
        }
        .mui-navbar .mui-bar .mui-title {
            display: inline-block;
            width: auto;
        }
        .mui-page-shadow {
            position: absolute;
            right: 100%;
            top: 0;
            width: 16px;
            height: 100%;
            z-index: -1;
            content: '';
        }
        .mui-page-shadow {
            background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
            background: linear-gradient(to right, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
        }
        .mui-navbar-inner.mui-transitioning,
        .mui-navbar-inner .mui-transitioning {
            -webkit-transition: opacity 300ms ease, -webkit-transform 300ms ease;
            transition: opacity 300ms ease, transform 300ms ease;
        }
        .mui-page {
            display: none;
        }
        .mui-pages .mui-page {
            display: block;
        }
        .mui-page .mui-table-view:first-child {
            margin-top: 15px;
        }
        .mui-page .mui-table-view:last-child {
            margin-bottom: 30px;
        }
        .mui-table-view {
            margin-top: 20px;
        }

        .mui-table-view span.mui-pull-right {
            color: #999;
        }
        .mui-fullscreen {
            position: fixed;
            z-index: 20;
            background-color: #000;
        }
        .mui-ios .mui-navbar .mui-bar .mui-title {
            position: static;
        }

        .mui-plus.mui-plus-stream .mui-stream-hidden{
            display: none !important;
        }
        /**type*/
        .mui-popover{
            width:100%;
            height:100%;
            border-radius: 0px;
            background-color: transparent;
            box-shadow:none;
            -webkit-box-shadow:none;
        }
        .mui-popover.mui-active{
            opacity:0.9;

        }
        .mui-badge{
            font-size:16px;
            background-color:white;
            margin-top:5px;
        }
        .mui-backdrop{
            z-index: 5 !important;
        }
    </style>
</head>

<body class="mui-fullscreen">
<div class="weui-gallery" id="gallery">
    <span class="weui-gallery__img" id="galleryImg"></span>
    <div class="weui-gallery__opr">
        <a href="javascript:" rel="external nofollow" class="weui-gallery__del">
            <i class="weui-icon-delete weui-icon_gallery-delete"></i>
        </a>
    </div>
</div>
<!--页面主结构开始-->
<div id="muiapp" class="mui-views">
    <div class="mui-view">
        <div class="mui-pages">
        </div>
    </div>
</div>
<!--页面主结构结束-->
<!--单页面开始-->
<div id="setting" class="mui-page">
    <!--<a href="/wechatservice/goods/add"><img src="__STATIC__/wechatservice/img/home_create.png" class="add_goods"/></a>-->
    <!--页面主内容区开始-->
    <div class="mui-page-content"><div class="mui-scroll-wrapper" id="refreshContainer">
        <div class="mui-scroll">

        <form class="" id="mainform" method="post" action="{:url('machine/save')}">
            <input type="hidden" name="machineid" value="{$machine.machineid}"/>
            <div class="page__bd page__bd_spacing">

                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd">机柜编号</div>
                    <div class="weui-panel__bd" style="padding:10px 15px;">
                        <input id="sn" name="sn" value="{$machine.containerid}" class="weui-input"
                               placeholder="请输入机柜编号" disabled/>
                    </div>
                </div>
                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd">名称</div>
                    <div class="weui-panel__bd" style="padding:10px 15px;">
                        <input id="machinename" name="machinename" value="{$machine.machinename}" class="weui-input" placeholder="请输入名称"/>
                    </div>
                </div>
                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd">分类</div>
                    <div class="weui-panel__ft">
                        <a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link">
                            <div class="weui-cell__bd" id="currenttags">{$groupnames}</div>
                            <input type="hidden" name="groups" id="groups" value="{$groupvalues}">
                            <span class="weui-cell__ft" id="open">选择分类</span>
                        </a>
                    </div>
                </div>
                <div class="weui-panel weui-panel_access">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    <p class="weui-uploader__title upload_head">实景照片</p>
                                    <div class="weui-uploader__info js_counter">{$pics|count}/4</div>
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="uploaderFiles" style="margin-bottom:0px;">
                                        {volist name="pics" id="vo" key="k"}
                                        <li class="weui-uploader__file" style="background-image:url('{$vo.path}')"></li>
                                        {/volist}
                                    </ul>
                                    <div class="weui-uploader__input-box">
                                        <input id="uploaderInput" class="weui-uploader__input js_file" type="file" accept="image/*"
                                               multiple="false">

                                    </div>
                                    <div id="hiddenUploaderFiles">
                                        {volist name="pics" id="vo" key="k"}
                                        <input name="picurl[]" type="hidden" value="{$vo.url}">
                                        {/volist}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd">展示信息</div>
                    <div class="mui-input-row">
                        <label>联系电话</label>
                        <input type="tel" id="mobile" name="mobile" value="{$machine.mobile}" class="mui-input-clear" placeholder="请输入联系电话">
                    </div>
                    <div class="mui-input-row">
                        <label>安装地址</label>
                        <input type="text" id="chooselocation" name="location" placeholder="请选择位置" value="{$machine.location}" >
                        <input type="hidden" id="lon" name="lon" value="{$machine.lon}"/>
                        <input type="hidden" id="lat" name="lat" value="{$machine.lat}"/>
                    </div>
                    <div class="mui-input-row">
                        <label>详细位置</label>
                        <input type="text" id="dailaddress" name="dailaddress" value="{$machine.dailaddress}" class="weui-input"
                               placeholder="请输入详细位置"  class="mui-input-clear" >
                    </div>
                </div>

                <!--<div class="weui-panel weui-panel_access">-->
                    <!--<div class="weui-panel__hd">其它</div>-->
                    <!--<div class="weui-cell">-->
                        <!--<div class="weui-cell__hd"><label class="weui-label ">机柜类型</label></div>-->
                        <!--<div class="weui-cell__bd rightnav">-->
                            <!--<a class=" ">请选择类型</a>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->

                <div class="weui-btn-area">
                    <button type="button" class="weui-btn weui-btn_primary" id="subbtn" style="padding:0 14px;">确定</button>
                    <a class="weui-btn weui-btn_default" href="javascript:" id="goback">返回</a>
                </div>
            </div>
        </form>
    </div>
    </div>
    </div>
    <!--页面主内容区结束-->
</div>
<!--单页面结束-->
<div id="account" class="mui-page">
    <div class="mui-page-content">
        <div style="height:40px;text-align:right;"><button type="button" id="closelocation" class="mui-btn mui-btn-primary" style="margin-right:5px;margin-top:4px;">确定</button></div>
        <iframe id="mapPage" width="100%" height="100%" frameborder=0
                src="https://apis.map.qq.com/tools/locpicker?search=1&type=1&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&referer=zhima">
        </iframe>
    </div>
</div>


<style>
    .tagsContaine .tagList{
        float:left;
    }
    .tagsContaine .tagList .tagItem{
        height: 30px;
        line-height: 22px;
        background-color: #fff;
        padding: 5px 10px;
        text-align: center;
        float: left;
        margin: 5px;
        border-radius: 10px;
        color: #000;
        font-size: 14px;
        letter-spacing: 0px;
        cursor: pointer;
    }
    .tagsContaine .tagList .tagItem .delete{
        display: block;
        float: right;
        width: 15px;
        height: 15px;
        background-image: url(__STATIC__/wechatservice/img/x.png);
        background-repeat: round;
        margin-top: -10px;
        margin-right: -10px;
    }
    .tagsContaine .tagList .tagItem2{
        height: 30px;
        line-height: 22px;
        background-color: #fff;
        padding: 5px 10px;
        text-align: center;
        float: left;
        margin: 5px;
        border-radius: 10px;
        color: #000;
        font-size: 14px;
        letter-spacing: 0px;
        cursor: pointer;
    }
    .tagsContaine .tagList .tagItem3{
        height: 30px;
        line-height: 22px;
        background-color: #fff;
        padding: 5px 10px;
        text-align: center;
        float: left;
        margin: 5px;
        border-radius: 10px;
        color: #000;
        font-size: 14px;
        letter-spacing: 0px;
        cursor: pointer;
    }
    .tagItem input{
        font-size: 14px;

    }
    .con:empty:before{
        content:attr(placeholder);
        font-size: 14px;
    }
    .con:focus{
        content:none;
    }
</style>
<!--页面主内容区结束-->
<div id="popover" class="mui-popover mui-fullscreen">
    <div class="mui-content-padded">
        <div class="mui-row">
            <div class="mui-col-sm-10 mui-col-xs-10 tagsContaine">
                <div class="tagList" id="searchtags">
                    <!--<div class="tagItem" id="1"><span>进口水果</span>-->
                    <!--<div class="delete"></div>-->
                    <!--</div>-->
                    <div class="tagItem" id="addlabel"><div class="con" id="added" contenteditable="true" placeholder="新标签" style ='max-width:180px; min-width:30px;'></div></div>
                </div>
            </div>
            <div class="mui-col-sm-2 mui-col-xs-2">
                <button type="button" class="mui-btn mui-btn-green" id="confirmtype" style="float:right;">确定
                </button>
            </div>
        </div>
        <hr/>
        <div class="mui-row" style="margin-top:10px;">
            <div class="mui-col-sm-12 mui-col-xs-12 tagsContaine">
                <div class="tagList" id="alltags">
                    <!--<div class="tagItem2" data-id="11"><span>进口水果</span></div>-->
                </div>
            </div>
        </div>
    </div>
</div>
</body>


<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.1.2/js/jquery-weui.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.1.2/js/swiper.min.js"></script>


<script src="__STATIC__/wechatservice/js/mui.min.js "></script>
<script src="__STATIC__/wechatservice/js/mui.view.js "></script>
<script src="__STATIC__/wechatservice/js/exif.js "></script>
<script>


    $(function () {

        // 允许上传的图片类型
        var allowTypes = ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'];
        // 1024KB，也就是 1MB
        var maxSize = 1024 * 1024 * 5;
        // 图片最大宽度
        var maxWidth = 860;
        // 最大上传图片数量
        var maxCount = 4;
        $('.weui-uploader__input').on('change', function (event) {
            var files = event.target.files;
            // 如果没有选中文件，直接返回
            if (files.length === 0) {
                return;
            }

            for (var i = 0, len = files.length; i < len; i++) {
                var file = files[i];
                var reader = new FileReader();

                // 如果类型不在允许的类型范围内
                if (allowTypes.indexOf(file.type) === -1) {
                    $.alert('该类型不允许上传');
                    continue;
                }

                if (file.size > maxSize) {
                    $.alert('图片太大，请上传5M之内的照片');
                    continue;
                }

                if ($('.weui-uploader__file').length >= maxCount) {
                    $.alert('最多只能上传' + maxCount + '张图片');
                    return;
                }

                reader.onload = function (e) {
                    var img = new Image();
                    img.onload = function () {
                        // 不要超出最大宽度
                        var w = Math.min(maxWidth, img.width);
                        // 高度按比例计算
                        var h = img.height * (w / img.width);
                        // var canvas = document.createElement('canvas');
                        // var ctx = canvas.getContext('2d');
                        // // 设置 canvas 的宽度和高度
                        // canvas.width = w;
                        // canvas.height = h;
                        // ctx.drawImage(img, 0, 0, w, h);
                        // var base64 = canvas.toDataURL('image/png');
                        var base64 = compress(img,w,h,0.4);
                        // 插入到预览区
                        var $preview = $('<li class="weui-uploader__file weui_uploader_status" style="background-image:url(' + base64 + ')"></li>');
                        $('.weui-uploader__files').append($preview);
                        var num = $('.weui-uploader__file').length;
                        $('.js_counter').text(num + '/' + maxCount);

                        // post base64格式
//
                        var param = {
                            'base64':base64
                        };
                        $.showLoading("上传中...");
                        $.ajax({
                            url: '/clientapi/image/base64_upload',
                            type: 'POST',
                            data: param,
                            //                cache: false,
                            //                processData: false,
                            //                contentType: false,
                            success:function (response) {
                                $.hideLoading();
                                $('#hiddenUploaderFiles').append('<input name="picurl[]" type="hidden" value="'+response+'">');
//                                $.alert(response.reason,siteTitle);
                            },
                            error:function () {
                                $.hideLoading();
                                alert('上传失败');
                            }
                        });
                    };

                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        //gallery
        var index; //第几张图片
        $('#uploaderFiles').on("click", "li", function() {
            index = $(this).index();
            $('#galleryImg').attr("style", this.getAttribute("style"));
            $('#gallery').fadeIn(100);
        });
        $('#gallery').on("click", function() {
            $('#gallery').fadeOut(100);
        });
        //删除图片
        $(".weui-gallery__del").click(function() {
            console.log('删除');
            $('#uploaderFiles').find("li").eq(index).remove();
            $('#hiddenUploaderFiles').find("input").eq(index).remove();
            var num = $('.weui-uploader__file').length;
            $('.js_counter').text(num + '/' + maxCount);
        });
        //map
        window.addEventListener('message', function(event) {
            var loc = event.data;
            var lat = loc.latlng.lat;
            var lng = loc.latlng.lng;
            var poiaddress = loc.poiaddress;
            $('#chooselocation').val(poiaddress);
            $('#lon').val(lng);
            $('#lat').val(lat);
        }, false);
        //
        var u = navigator.userAgent;
        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
        // var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
        if(isAndroid){
            $('#uploaderInput').attr("capture","camera");
        }
        //获取图片方向
        function getPhotoOrientation(img) {
            var orient;
            EXIF.getData(img, function () {
                orient = EXIF.getTag(this, 'Orientation');
            });
            return orient;
        }
        //图片压缩
        function compress(img, width, height, ratio) {
            var canvas, ctx, img64, orient;

            //获取图片方向
            orient = getPhotoOrientation(img);

            canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;

            ctx = canvas.getContext("2d");

            //如果图片方向等于6 ，则旋转矫正，反之则不做处理
            if (orient == 6) {
                ctx.save();
                ctx.translate(width / 2, height / 2);
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(img, 0 - height / 2, 0 - width / 2, height, width);
                ctx.restore();
            } else {
                ctx.drawImage(img, 0, 0, width, height);
            }

            img64 = canvas.toDataURL("image/jpeg", ratio);
            return img64;
        }
    });
</script>
<script>
    //初始化单页view
    var viewApi = mui('#muiapp').view({
        defaultPage: '#setting'
    });
    mui('.mui-scroll-wrapper').scroll();
    mui("#refreshContainer").on("tap","#chooselocation",chooselocation);
    mui("#refreshContainer").on("tap","#goback",backtolast);
    mui("#account").on("tap","#closelocation",closelocation);
    function chooselocation() {
        viewApi.go('#account');
    }
    function closelocation() {
        viewApi.back();
    }
    function backtolast() {
        history.go(-1);
    }


    $("#subbtn").on("click", function () {
        $('#groups').val(searchparams);
        var machinename = $("#machinename").val();
        var sn = $("#sn").val();
        var mobile = $("#mobile").val();
        var lon = $("#lon").val();
        var dailaddress = $("#dailaddress").val();
        if(isNull(machinename)){
            $.alert("请输入机柜名称", "提示");
            return;
        }
        if(isNull(sn)){
            $.alert("请输入机柜编号序列号", "提示");
            return;
        }
        if(isNull(mobile)){
            $.alert("请输入联系电话", "提示");
            return;
        }
        if(isNull(lon)){
            $.alert("请选择位置", "提示");
            return;
        }
        if(isNull(dailaddress)){
            $.alert("请输入详细位置", "提示");
            return;
        }
        $.showLoading("正在操作...");
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '/wechatservice/machine/save',
            data: $('#mainform').serialize(),
            success: function (result) {
                $.hideLoading();
                if(result.code == 1){
                    history.go(-1);
                }else{
                    alert(result.msg);
                }
            },
            error: function(data) {
                $.hideLoading();
                alert("error:"+data.responseText);
            }
        });
    });
    function isNull(str){
        if ( str == "" ) return true;
        var regu = "^[ ]+$";
        var re = new RegExp(regu);
        return re.test(str);
    }
    //标签选择
    document.getElementById("open").addEventListener('tap',function () {
        //清空数据

        mui("#popover").popover("toggle");
    });
    //        document.getElementById("confirmtype").addEventListener('tap',function () {
    //            mui("#popover").popover("toggle");
    //        });
    mui("#popover").on("tap", ".tagItem2", function() {
        var id = this.getAttribute("data-id");
        var typename = this.querySelector("span").innerHTML;
        var html = '<div class="tagItem" id="'+id+'"><span>'+typename+'</span><div class="delete"></div></div>';
        $('#searchtags').prepend(html);
//            if(id){
//                document.getElementById("col1").value = this.querySelector(".col1").innerHTML;
//                document.getElementById("col2").value = this.querySelector(".col2").innerHTML;
//                document.getElementById("col3").value = this.querySelector(".col3").innerHTML;
//                document.getElementById("col1").setAttribute("demoid", id);
//                title.innerHTML = "编辑数据";
//                if(!add_div.classList.contains("mui-hidden")){
//                    add_div.classList.add("mui-hidden");
//                }
//                edit_div.classList.remove("mui-hidden");
//                mui("#popover").popover("toggle");
//            }

    });
    mui("#popover").on("tap", ".delete", function() {
        var id = this.parentNode.getAttribute("id");
        $('#'+id).remove();
    });
    var searchparams = "{$groupvalues}";
    mui("#popover").on("tap", "#confirmtype", function() {
        var addedlabel = $('#added').html();mui("#popover").popover("toggle");
        if(!isNull(addedlabel)){
            $.ajax({
                type: "POST",
                dataType: "json",
                url: '/wechatservice/machine/addgroup',
                data: {
                    'label':addedlabel
                },
                success: function (result) {
                    if(result.code == 200){
                        var id = result.data;
                        var html = '<div class="tagItem" id="'+id+'"><span>'+addedlabel+'</span><div class="delete"></div></div>';
                        $('#searchtags').prepend(html);
                        $('#added').html('');
                        appendlbs();
                    }else{
                        alert(result.msg);
                    }
                },
                error: function(data) {
                    alert("error:"+data.responseText);
                }
            });
        }else{
            appendlbs();

        }

//        mui('#refreshContainer').pullRefresh().refresh(true);
//        mui('#refreshContainer').pullRefresh().pulldownLoading();
    });
    function appendlbs() {
        searchparams = '';
        $('#currenttags').html('');
        mui(".tagItem").each(function () {
//                alert(this.getAttribute("id"));
            searchparams = searchparams+ this.getAttribute("id")+',';
            var typename = this.querySelector("span").innerHTML;
            var html = '<span>'+typename+'</span>  ';
            $('#currenttags').append(html);
        });

    }
    $(function() {
        mui.ajax('/wechatservice/machine/grouplist',{
            data:{
//                    page:page,
//                    rows:rows
            },
            dataType:'json',//服务器返回json格式数据
            type:'get',//HTTP请求类型
            timeout:10000,//超时时间设置为10秒；
            success:function(data){
                for(var i=0;i<data.data.length;i++){
                    var html = '<div class="tagItem2" data-id="'+data.data[i].groupid+'"><span>'+data.data[i].groupname+'</span></div>';
                    $('#alltags').append(html);
                }
            },
            error:function(xhr,type,errorThrown){
                //异常处理；
                console.log(type);
            }
        });
    })
</script>

</html>