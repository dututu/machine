<!--包含头部文件-->
{include file="public/header" /}
<!-- jqGrid组件基础样式包-必要 -->
<link rel="stylesheet" href="__STATIC__/admin/assets/javascripts/jqGrid_5/css/ui.jqgrid.css"/>

<!-- jqGrid主题包-非必要 -->
<!-- 在jqgrid/css/css这个目录下还有其他的主题包，可以尝试更换看效果 -->
<!--<link rel="stylesheet" href="__STATIC__/admin/assets/javascripts/jqGrid_5/css/ui.jqgrid-bootstrap-ui.css" />-->

<link rel="stylesheet" href="__STATIC__/admin/css/gridlist.css"/>
<style>
    .lead {
        font-size: 16px;
        font-weight: normal;
        margin-bottom: 0px;
        line-height: 20px;
    }

    .ui-jqgrid-hdiv {
        display: none;
    }

    .pull-left {
        float: left;
        padding-left: 10px;
        padding-top: 5px;
    }

    .pull-right {
        padding-right: 10px;
    }

    .ui-paging-pager {
        font-size: 14px;
    }

    .jqgrow td {
        border-left: 1px solid #DDDDDD;
    }

    #pager2 {
        padding: 0px !important;
    }

    #pg_pager2 {
        padding: 5px !important;
        border-left: 1px solid #DDDDDD !important;
        border-right: 1px solid #DDDDDD !important;
    }
</style>
<div id='wrapper'>
    <!--包含菜单文件-->
    {include file="public/menu" /}
    <section id='content'>
        <div class='container-fluid'>
            <div class='row-fluid' id='content-wrapper'>
                <div class='span12'>
                    <div class='page-header'>
                        <h1 class='pull-left'>
                            <i class='icon-tag'></i>
                            <span>电子标签</span>
                        </h1>
                        <div class='pull-right'>
                            <ul class='breadcrumb'>
                                <li>
                                    <a href="{:url('index/index')}"><i class='icon-home' style="font-size:17px;"></i>
                                    </a>
                                </li>
                                <li class='separator'>
                                    <i class='icon-angle-right'></i>
                                </li>
                                <li>
                                    电子标签
                                </li>
                            </ul>
                        </div>
                    </div>


                    <div id='orders'>
                        <div class='row-fluid'>
                            <div class='span5'>
                                <div class='responsive-table'>
                                    <div class='scrollable-area'>
                                        <!-- jqgrid -->
                                        <table id="gridTable" class=""></table>
                                        <!-- jqgrid end-->
                                        <div id="pager2"></div>
                                    </div>
                                </div>
                            </div>
                            <div class='span7'>
                                <div class='row-fluid' id='detail'>
                                    <div class='span12 box'>
                                        <div class='box-content'>
                                            <div class="pull-left">交易编号：
                                                <span id="onumber"></span>
                                            </div>
                                            <div class='pull-right'>
                                                <a class='btn btn-default'  id="unbtn" href='javascript:fahuo();'>异常</a>
                                            </div>
                                            <div class='clearfix'></div>
                                            <div class="text-center" style="color: red;display: none" id="unusual">异常原因</div>
                                            <div class='clearfix'></div>
                                            <hr class='hr-normal'/>
                                            <div class='pull-left lead'>
                                                <i class='icon-truck contrast' style="color:black !important;"></i>平台交易信息：<span id="r_on"></span>
                                                <div class="pull-right span8" id="totalfee">实付金额:3000元</div>
                                                <div class="pull-right span8" id="paytype">支付方式:3000元</div>
                                                <div class="pull-right span8" id="paystatus">订单状态:3000元</div>
                                                <div class="pull-right span8" id="nickname">买家昵称:3000元</div>
                                                <div class="pull-right span8" id="mobile">联系电话:3000元</div>
                                                <div class="pull-right span8" id="unionid">微信UnionID:3000元</div>
                                                <div class='clearfix'></div>
                                            </div>
                                            <div class='clearfix'></div>
                                            <hr class='hr-normal' />
                                            <div class='pull-left lead'>
                                                <i class='icon-truck contrast' style="color:black !important;"></i>微信支付交易信息：
                                                <div class="pull-right span8" id="batchno">微信订单号:3000元</div>
                                                <div class="pull-right span8" id="serialno">商户订单号:3000元</div>
                                                <div class="pull-right span8" id="income">对账单金额:3000元</div>
                                                <div class="pull-right span8" id="billtype">支付方式:3000元</div>
                                                <div class="pull-right span8" id="payresult">订单状态:3000元</div>
                                                <div class="pull-right span8" id="batchno2">费率:3000元</div>
                                                <div class="pull-right span8" id="fees">手续费:3000元</div>
                                                <div class='clearfix'></div>
                                            </div>
                                            
                                            <hr class='hr-normal' />
                                            <div class='pull-left lead' id="machineinfo" style="display: none;">
                                                <i class='icon-truck contrast' style="color:black !important;"></i>机柜信息：
                                                <div class="pull-right span8" id="people">运营人:3000元</div>
                                                <div class="pull-right span8" id="machinename">机柜名称:3000元</div>
                                                <div class='clearfix'></div>
                                            </div>
                                            <div class='clearfix'></div>
                                            <div class='form-actions'>
                                                <ul class='pager'>
                                                    <li class='previous'>
                                                        <a href='#' id="last">上一单</a>
                                                    </li>
                                                    <li class='next'>
                                                        <a href='#' id="next">下一单</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </section>
</div>
<!--包含底部js文件-->
{include file="public/footer" /}
<!-- jqGrid插件包-必要 -->
<script type="text/javascript" src="__STATIC__/admin/assets/javascripts/jqGrid_5/js/jquery.jqGrid.min.js"></script>
<!-- jqGrid插件的多语言包-非必要 -->
<!-- 在jqgrid/js/i18n下还有其他的多语言包 -->
<script type="text/javascript" src="__STATIC__/admin/assets/javascripts/jqGrid_5/js/i18n/grid.locale-cn.js"></script>
<script>
    var accountid = "{$accountid}";
    
    var rows;
    $(function () {
        //页面加载完成之后执行
        pageInit();
    });

    function pageInit() {
        //创建jqGrid组件
        //订单状态：1 购物中，2待结账，3已取消，4待支付，5已付款，6已欠费，7转退款，8已完成
        jQuery("#gridTable").jqGrid(
            {
                url: 'getBillDetailList',//组件创建完成之后请求数据的url
                postData: {
                    accountid: accountid
                },
                datatype: "json",//请求数据返回的类型。可选json,xml,txt
                
                colModel: [ //jqGrid每一列的配置信息。包括名字，索引，宽度,对齐方式.....
                    {
                        name: 'batchno',
                        index: 'batchno',
                        hidden: true
                    },
                    {
                        name: 'billtype',
                        index: 'billtype',
                        hidden: true
                    },
                    {
                        name: '',
                        index: 'accountstatus',
                        sortable: false,
                        align: "left",
                        formatter: function (cellvalue, options, rowObject) {
                            var status = '';
                            var labelclass = '';
                            if (rowObject.accountstatus == "1") {
                                status = "<span class='label label-success'>正常</span>";
                            } else if (rowObject.accountstatus != "1") {
                                status = "<span class='label label-important'>异常</span>";
                            }
                            var html = "<div class='pull-left'><p><strong>" + rowObject.batchno + "</strong></p><p>" + status + "</p></div><div class='text-right pull-right'><h4 class='contrast price'>   </h4><p><i class='icon-time'></i><span class='has-tooltip' style='margin-left:5px;' data-title=''>" + rowObject.transactiontime + "</span></p></div>";
                            return html;
                        }
                    }
                ],
                page:1,
                rownumbers: false,
                rowNum: 10,//一页显示多少条
                rowList: [10, 20, 30],//可供用户选择一页显示多少条
                pager: '#pager2',//表格页脚的占位符(一般是div)的id
//				sortname : 'id',//初始化的时候排序的字段
//				sortorder : "desc",//排序方式,可选desc,asc
                mtype: "post",//向后台请求数据的ajax的类型。可选post,get
//          		styleUI: '',//设置jqgrid的全局样式为bootstrap样式 Bootstrap
                viewrecords: false,
                autowidth: true,
                pagerpos: "left",
                recordpos: "left",
                height: "auto",
                loadComplete: function (xhr) {
                    $("#gridTable").closest(".ui-jqgrid-bdiv").css({'overflow-y': 'auto'});//,'overflow-x':'hidden'
                        rows = xhr.rows;
            
                        if (rows.length > 0) {
                          loaddetail(rows[0].batchno, rows[0].billtype);
                        }
                    // if(orderid!=''&&orderid!=null){
                    //     loaddetail(orderid);
                    // }else{
                    //     if(rows.length>0){
                    //         loaddetail(rows[0].orderid);
                    //     }
                    // }
                    // $('#first_pager2').hide();
                    // $('#last_pager2').hide();
                },
                onSelectRow: function (rowid) {
                    
                    $('#gridTable tr').removeClass("ui-state-highlight");
                    var rowData = jQuery("#gridTable").getRowData(rowid);
                    console.log(rowData);
                    var batchno = rowData['batchno'];
                    var billtype = rowData['billtype'];
                    loaddetail(batchno, billtype);
//                    var page = $('#gridTable').getGridParam('page');
//                    location.href = 'detail?orderid='+orderid+'&page='+page;
                }
            });
    }
    function loaddetail(batchno, billtype) {
        var batchno = batchno;
        var index = layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
        });
        for(var i = 0;i<rows.length;i++){
            if(rows[i].batchno == batchno){
                if(rows.length == 1){
                    $("#last").hide();
                    $("#next").hide();
                }else{
                    if(i == 0){
                        $("#last").hide();
                        $("#next").show();
                        $("#next").attr("href","javascript:loaddetail('"+rows[i+1].batchno+"','"+ rows[i + 1].billtype+"');");
                    }else if(i == rows.length-1){
                        $("#last").show();
                        $("#next").hide();
                        $("#last").attr("href","javascript:loaddetail('"+rows[i-1].batchno+"','" + rows[i - 1].billtype +"');");
                    }else{
                        $("#last").show();
                        $("#next").show();
                        $("#last").attr("href","javascript:loaddetail('"+rows[i-1].batchno+"','" + rows[i - 1].billtype +"');");
                        $("#next").attr("href","javascript:loaddetail('"+rows[i+1].batchno+"','" + rows[i + 1].billtype +"');");
                    }
                }

            }
        }
        //
        $('#orderid').val(batchno);
        var postData = {
            'batchno': batchno,
            'billtype': billtype
        };
        var url = 'detaildata';
        $.post(url,postData,function (result) {
            if(result.code == 0){
                layer.close(index);
                //var orderstatus = result.data.rfidorder.orderstatus;
                if(result.result.accountstatus==1) {
                    $('#unusual').hide()
                    $('#unbtn').hide()
                } else if(result.result.accountstatus==2) {
                    $('#unusual').html('订单异常')
                    $('#unusual').show()
                    $('#unbtn').show()
                } else if(result.result.accountstatus==3) {
                    $('#unusual').html('对账单异常')
                    $('#unusual').show()
                    $('#unbtn').show()

                }
                $('#onumber').html(result.result.batchno)
                $('#totalfee').html('实付金额：'+result.result.income/100+'元');
                if(result.result.paytype==2 || result.result.paytype == 1)
                    $('#paytype').html('支付方式：微信支付');
                else
                    $('#paytype').html('支付方式：未知支付方式');
                    //1 成功 2未支付 3待支付 4已取消 5转退款',
                if(result.result.paystatus==1)
                    $('#paystatus').html('订单状态：成功');
                else if (result.result.paystatus == 2) 
                    $('#paystatus').html('订单状态：未支付');
                else if (result.result.paystatus == 3)
                    $('#paystatus').html('订单状态：待支付');
                else if (result.result.paystatus == 4)
                    $('#paystatus').html('订单状态：已取消');
                else if (result.result.paystatus == 5)
                    $('#paystatus').html('订单状态：转退款');
                $('#nickname').html('收货人：'+result.result.nickname);
                $('#mobile').html('联系电话：'+result.result.mobile);
                $('#unionid').html('微信UnionID：'+result.result.unionid);
                //已付款
                $('#batchno').html('微信订单号：' + result.result.batchno);
                $('#serialno').html('商户订单号：' + result.result.serialno);
                $('#income').html('对账单金额：' + result.result.income/100+'元');
                if(result.result.billtype==2)
                    $('#billtype').html('支付方式：微信支付');
                else 
                    $('#billtype').html('支付方式：未知');
                if(result.result.payresult==1)
                    $('#payresult').html('订单状态：收入');
                else if (result.result.payresult == 2)
                    $('#payresult').html('订单状态：退款');
                $('#batchno2').html('费率：' + result.result.batchno);
                $('#fees').html('手续费：' + result.result.fees);
                if(result.result.bill==1) {
                    $('#machineinfo').show()
                    $('#people').html('运营人：aaa')
                    $('#machinename').html('机柜名称：'+result.result.machinename)

                }
            }else{
                layer.close(index);
                alert(result.msg);
            }
        },"json");
    }
    function apply() {
        var cansub = true;
        $("#refundfee").each(function () {
            if ($(this).val() == "") {
                alert("请填写退款金额");
                cansub = false;
                return;
            }
        });
        $("#refundremark").each(function () {
            if ($(this).val() == "") {
                alert("请填写退款备注信息");
                cansub = false;
                return;
            }
        });
        if (cansub) {
            $.ajax({
                cache: true,
                type: "POST",
                url: '/admin/trade/fahuo',
                data: $('#refundform').serialize(),
                async: false,
                error: function (request) {
                    alert("Connection error");
                },
                success: function (data) {
                    if (data.code == 200) {
                        location.reload();
                    } else {
                        alert(data.msg);
                    }

                }
            });
        }

    }
    function fahuo() {
        var cansub = true;
        if ($('#expresscompany').val() == "") {
            alert("请填写快递公司名称");
            cansub = false;
            return;
        }
        if ($('#expressno').val() == "") {
            alert("请填写快递单号");
            cansub = false;
            return;
        }
        var index = layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
        });
        if (cansub) {
            $.ajax({
                cache: true,
                type: "POST",
                url: '/admin/rfid/fahuo',
                data: $('#fahuoform').serialize(),
                async: false,
                error: function (request) {
                    layer.close(index);
                    alert("Connection error");
                },
                success: function (data) {
                    layer.close(index);
                    if (data.code == 200) {
                        location.reload();
                    } else {
                        alert(data.msg);
                    }

                }
            });
        }

    }
</script>
</body>
</html>